# FastAPI + Redis PubSub Template
![Static Badge](https://img.shields.io/badge/python-...-brightgreen?style=flat&logo=python)
![Static Badge](https://img.shields.io/badge/fastapi-...-brightgreen?style=flat&logo=python)
![Static Badge](https://img.shields.io/badge/coverage-0%-red?style=flat&logo=pytest)
![Static Badge](https://img.shields.io/badge/tests-failing-red?style=flat&logo=pytest)
![Static Badge](https://img.shields.io/badge/flake8-failing-red?style=flat&logo=python)
![Static Badge](https://img.shields.io/badge/mypy-failing-red?style=flat&logo=python)

## Оглавление
* [Разворачивание проекта](#разворачивание-проекта)
    * [Зависимости](#зависимости)
    * [Окружение](#окружение)
    * [Запуск в локальном окружении](#запуск-в-локальном-окружении)
    * [Запуск в тестовом окружении](#запуск-в-тестовом-окружении)
    * [Запуск в прод окружении](#запуск-в-прод-окружении)
    * [После запуска](#после-запуска)
    * [Возможные ошибки](#возможные-ошибки)
* [Стэк](#стэк)
    * [Основные инструменты](#основные-инструменты)
    * [Другие библиотеки / интеграции](#другие-библиотеки--интеграции)
* [Запуск тестов](#запуск-тестов)
    * [Внутри Docker-контейнера (рекомендуется)](#внутри-docker-контейнера-рекомендуется)
    * [Вне Docker-контейнера](#вне-docker-контейнера)
* [Запуск flake8](#запуск-flake8)
    * [Внутри Docker-контейнера (рекомендуется)](#внутри-docker-контейнера-рекомендуется-1)
    * [Вне Docker-контейнера](#вне-docker-контейнера-1)
* [Запуск mypy](#запуск-mypy)
    * [Внутри Docker-контейнера (рекомендуется)](#внутри-docker-контейнера-рекомендуется-2)
    * [Вне Docker-контейнера](#вне-docker-контейнера-2)
* [Разработка](#разработка)
    * [Миграции](#миграции)
    * [Форматирование кода](#форматирование-кода)
    * [Git хуки](#git-хуки)

## Разворачивание проекта
### Зависимости
* docker
* docker compose
* python 3.8+ (опционально, для локального запуска pytest/flake8/mypy)
* poetry (опционально, для локального запуска pytest/flake8/mypy)
### Окружение
Перед запуском контейнеров, необходимо убедиться, что в корневой директории проекта присутствует файл `.env`, в котором заполнены все необходимые переменные окружения.<br>
Названия этих переменных можно посмотреть в [.env.example](./.env.example)<br>

<details>
<summary><b>Подробное описание переменных окружения</b></summary>
<p>

#### PROJECT_NAME
Название проекта
#### DEBUG
Режим отладки<br>
0 - выключен<br>
1 - включен<br>
Если включен, то:
* 500 ошибки сервера не будут обработаны обработчиком исключений
* В логах будут отображаться запросы в БД, генерируемые в рамках запроса
#### PROD
Режим прод окружения<br>
0 - выключен<br>
1 - включен<br>
Если выключен, то:
* Будет доступна документация swagger-ui/redoc
* Работа с платежными системами будет работать в боевом режиме
* Чувствительные данные будут исключены из логов
#### MEDIA_PATH
Путь к директории, в которой хранятся медиа-файлы
#### MEDIA_URL
Префикс в ссылке для медиа-файлов
#### STATIC_PATH
Путь к директории, в которой хранятся статические файлы
#### STATIC_URL
Префикс в ссылке для статических-файлов
#### LOG_PATH
Путь к директории, в которой хранятся лог-файлы
#### Redis
REDIS_HOST должен соответствовать названию сервиса Redis из compose конфигурации<br>
REDIS_PORT - любой доступный на хосте порт<br>

</p>
</details>

### Запуск в локальном окружении
```bash
docker-compose -f docker-compose.local.yml up
```
или
```bash
make localup
```
После запуска проект будет доступен по адресу http://localhost:.../
### Запуск в тестовом окружении
```bash
docker-compose -f docker-compose.develop.yml up
```
или
```bash
make developup
```
### После запуска
Проект станет доступен по порту ...<br>
В локальном окружении достаточно перейти по адресу http://localhost:.../<br>
В другом окружении необходимо настроить домен, при обращении к которому веб-сервер (Nginx/Apache) будет проксировать все запросы на порт ...
### Возможные ошибки
Если на хосте установлена docker compose версии >2, то может возникнуть ошибка синтаксиса команды. В таком случае в командах выше нужно заменить
```bash
docker-compose
```
на 
```bash
docker compose
```

## Стэк
### Основные инструменты
* Используемый язык программирования — `Python ...`
* Используемый фреймворк — `FastAPI ...`
* Используемый инструмент для реализации PubSub — `Redis ...`
### Другие библиотеки / интеграции
* `uvicorn (...)` — HTTP-сервер для FastAPI
* `redis (...)` — библиотека для работы с Redis в Python
* `websockets (...)` - библиотека для работы с websocket-соединениями
* `JSON-log-formatter (...)` — библиотека для форматирования логов в JSON-формате
* `dependency-injector (...)` — библиотека для внедрения зависимостей (DI)
* `pytest (...)` — библиотека для тестирования
* `pytest-cov (...)` — библиотека для оценки покрытия кода тестами через pytest
* `pytest-mock (...)` — библиотека для мока зависимостей через pytest
* `pytest-timeout (...)` — библиотека для ограничения времени выполнения тестов через pytest 
* `pytest-asyncio (...)` — библиотека для тестирования асинхронного кода
* `concurrent-log-handler (...)` — библиотека для последовательной записи логов в файлы при запуске веб приложения через несколько воркеров (как в uvicorn)
* `mypy (...)` — статический анализатор типов
* `flake8 (...)` — инструмент линтинга для Python
* `black (...)` — библиотека для форматирования кода на языке Python
* `isort (...)` - библиотека для сортировки импортов

## Запуск тестов
### Внутри Docker-контейнера (рекомендуется)

1. Зайти в контейнер `asgi` через команду

    ```bash
    docker exec -it asgi bash
    ```
2. Начать выполнение тестов через команду
    ```bash
    pytest
    ```

или
```bash
make test
```

### Вне Docker-контейнера

При таком запуске тесты, в которых тестируется работа с БД, выполнятся с ошибкой<br>
При ошибке выполнения команды запустите тесты внутри Docker-контейнера
1. Перейти в директорию с [конфигурационным файлом](./src/pyproject.toml)
2. Начать выполнение тестов через команду

    ```bash
    poetry run pytest
    ```

## Запуск Flake8
### Внутри Docker-контейнера (рекомендуется)

1. Зайти в контейнер `asgi` через команду

    ```bash
    docker exec -it asgi bash
    ```
2. Начать выполнение flake8 через команду
    ```bash
    flake8 .
    ```

или
```bash
make flake8
```

### Вне Docker-контейнера

1. Перейти в директорию с [конфигурационным файлом](./src/.flake8)
2. Начать выполнение flake8 через команду

    ```bash
    poetry run flake8 .
    ```

## Запуск mypy
### Внутри Docker-контейнера (рекомендуется)

1. Зайти в контейнер `asgi` через команду

    ```bash
    docker exec -it asgi bash
    ```
2. Начать выполнение mypy через команду
    ```bash
    mypy .
    ```

или
```bash
make mypy
```

### Вне Docker-контейнера

При возникновении ошибок запуск возможен только внутри Docker-контейнера
1. Перейти в директорию с [конфигурационным файлом](./src/pyproject.toml)
2. Начать выполнение mypy через команду

    ```bash
    poetry run mypy .
    ```

## Разработка
### Миграции
#### Создание миграции
```bash
docker exec -it asgi alembic revision -m "Message"
```
или
```bash
make makemigrations MESSAGE="Message"
```

#### Выполнение миграций
```bash
docker exec -it asgi alembic upgrade head
```
или
```bash
make migrate
```

### Форматирование кода
При разработке рекомендуется использовать [black](https://pypi.org/project/black/), чтобы поддерживать чистоту кода и избегать лишних изменений при работе с гитом.<br>
Пример конфигурационного файла для Visual Studio Code `.vscode/settings.json`:
```json
{
    "[python]": {
        "editor.defaultFormatter": "ms-python.black-formatter",
        "editor.formatOnSave": true
    }
}
```

### Git хуки
При разработке рекомендуется использовать [pre-commit](https://pre-commit.com/), чтобы перед формированием МР код был уже подготовленным и поверхностно проверенным (например, через `flake8`)<br><br>
**Для использования должны быть установлены dev-зависимости**

#### Pre-commit хуки
Установка
```bash
poetry run pre-commit install
```
Удаление
```bash
poetry run pre-commit uninstall
```
После установки, при каждом коммите будут отрабатывать хуки из [конфигурационного файла](./src/.pre-commit-config.yaml), предназначенные для коммитов (`stages: [commit]`)

#### Pre-push хуки
Установка
```bash
poetry run pre-commit install --hook-type pre-push
```
Удаление
```bash
poetry run pre-commit uninstall -t pre-push
```
После установки, при каждом пуше будут отрабатывать хуки из [конфигурационного файла](./src/.pre-commit-config.yaml), предназначенные для пушей (`stages: [push]`)
